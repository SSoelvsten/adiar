\begin{blstlisting}
    Reduce($\ReduceLforward$: Edge[], $\ReduceQdep$: PriorityQueue<Edge>): Node[]
      // Index of next output in stream
      iO = 0

      // Index into *@\color{cGray} $\ReduceLforward$@*
      iF := $\ReduceLforward$.length - 1

      // Process bottom-up each layer except for the root-layer
      for j := n-1 downto 2:
          $L_{j}$ := []

          // Merge nodes of layer j with result of prior computations
          while $\ReduceQdep$.peek().source.label = j:
              e_low  := $\ReduceQdep$.extract_max()
              e_high := $\ReduceQdep$.extract_max()

              $L_{j}$.append(node_of_edges(e_low, e_high))

          // Apply reduction rules
          ($L_{j,\mathit{out}}$, $L_{j,\mathit{red:}1}$, $L_{j,\mathit{red:}2}$) = reduce_layer($L_{j}$)

          // Notice, to-be outputted nodes in $\color{cGray}L_{j,\mathit{out}}$ and rule-2-reduced
          // nodes in $\color{cGray}L_{j,\mathit{red:}2}$ are already sorted in decreasing
          // order according to i.

          iR2 = 0
          for (w,w',i) in $L_{j,\mathit{out}}$:
              w'.index := iO++
              output w'

              while iR2 < $L_{j,\mathit{red:}2}$.length $\land$ $L_{j,\mathit{red:}2}$[iR2] is (_,_,i):
                  $L_{j,\mathit{red:}2}$[iR2++][1].index := w'.index

          // Forward processing information to layers j-1 .. 1
          $L_{j:F}$ := $L_{j,\mathit{out}}$ ++ $L_{j,\mathit{red:}1}$ ++ $L_{j,\mathit{red:}2}$
          sort (w,w',i) in $L_{j:F$ by w.index

          { source, is_high, target } := $\ReduceLforward$[iF]
          for (w,w',_) in $L_{j:F}$:
              while target = w:
                  $\ReduceQdep$.insert({
                    source=source,
                    is_high=is_high,
                    target=nodearc_of_node(w')
                  })
                  { source, is_high, target } := $\ReduceLforward$[--iF]

      // Process the root
      (_, t_low,  _) := $\ReduceQdep$.extract_max()
      (_, t_high, _) := $\ReduceQdep$.extract_max()
      output { label: v.label, index: iO, low: t_low, high: t_high }
\end{blstlisting}
