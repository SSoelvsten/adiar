\begin{blstlisting}
  type Node$^2$ = Node$\times$Node

  reduce_layer(nodes: Node[]) : Node$^2$[]$\times$Node$^2$[]$\times$Node$^2$[]
    sort $w \in $ nodes by low first and high second
    O$_{\mathit{out}}$, O$_{\mathit{red:}1}$, O$_{\mathit{red:}2}$ = []

    for i := 0 to nodes.length - 1:
      w := data[i]

      // Reduction rule 1:
      if w.low = w.high:
        O$_{\mathit{red:}1}$.append((w,w_low,w.index))
      else:
        w' = {
          index: NIL,
          label: w.label,
          low: w.low,
          high: w.high
        }

        O$_{\mathit{out}}$.append(w,w')
        i++

        // Reduction rule 2:
        while i < data.length:
          o = data[i]
          if w.low = o.low $\land$ w.high = o.high:
            O$_{\mathit{red:}2}$.append((o,w'))
            i++
          else break

    return (O$_{\mathit{out}}$, O$_{\mathit{red:}1}$, O$_{\mathit{red:}2}$)
\end{blstlisting}
