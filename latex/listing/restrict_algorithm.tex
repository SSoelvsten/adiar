\begin{blstlisting}
  Restrict(G : Node[], A : (int, bool)[]) : Node[] + NodeArc.Sink
    sort (l,v) in A *@by@* l
    $\RestrictQrec$, $\ReduceQdep$ := $\emptyset$ : PriorityQueue<Edge>
    $\ReduceLforward$ := [] : Edge[]
    iA := 0
    (a_label, a_value) := A[iA]

    // Process the root and create initial recursion requests
    v = G.V[G.V.length - 1]
    if a_label = v.label:
      rec_child := if a_value then v.high else v.low

      if is_sink(rec_child): return NodeArc.Sink{ value=v.high.value }
      $\RestrictQrec$.insert(Edge{source=NIL, is_high=a_value, target=rec_child})

      (a_label, a_value) := A[++iA]
    else:
      (low_edge, high_edge) := edges_of_node(v)

      if is_sink(v.low): $\ReduceQdep$.insert(low_edge)
      else: $\ReduceLforward$.append(low_edge)
            $\RestrictQrec$.insert(low_edge)
      if is_sink(v.high): $\ReduceQdep$.insert(high_edge)
      else: $\ReduceLforward$.append(high_edge)
            $\RestrictQrec$.insert(high_edge)

    // Process all to-be-visited nodes in topological order
    while !$\RestrictQrec$.empty():
      Edge{ source, is_high, target } := $\RestrictQrec$.extract_min()
      v := G.V[target.index]

      // Skip to-be-substituted variables that we didn't see
      while iA < A.length $\land$ a_label < v.label:
        (a_label, a_value) := A[++iA]

      // Process node and forward information
      if a_label = label:
        rec_child := if a_value then v.high else v.low
        request := Edge{ source, is_high=a_value, target=rec_child }

        if is_sink(rec_child)
        then if source = NIL
          then: return NodeArc.Sink{ value=rec_child.value }
          else: $\ReduceQdep$.insert(request)
        else: $\ReduceLforward$.append(request)
              $\RestrictQrec$.insert(request)
      else:
        $\RestrictQrec$.insert(edges_of_node(v))

        if source <> NIL:
          while True:
            $\ReduceLforward$.append(Edge{ source, is_high, target })
            if !$\RestrictQrec$.empty() $\land$ $\RestrictQrec$.peek_min().target = target:
              Edge{ source, is_high, target } := $\RestrictQrec$.extract_min()
            else: break

    return Reduce($\ReduceLforward, \ReduceQdep$)
\end{blstlisting}
